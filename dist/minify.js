"use strict";function revModules(){var revFiles=[configWrap.config.tmp+"app/**/*.*","!"+configWrap.config.tmp+"app/**/*.component.js","!"+configWrap.config.tmp+"app/app.all.state.js"];return gulp.src(revFiles).pipe(plumber({errorHandler:handleErrors})).pipe(sourcemaps.init()).pipe(gulpIf("*.js",jsTask())).pipe(gulpIf("*.css",cssTask())).pipe(gulpIf("*.html",htmlmin({collapseWhitespace:!0}))).pipe(gulpIf("**/*.!(txt)",rev())).pipe(gulpIf("**/*.!(txt|html)",sourcemaps.write("."))).pipe(gulp.dest(configWrap.config.tmp+"rev/")).pipe(rev.manifest()).pipe(gulp.dest(configWrap.config.revDest))}function revState(){var revFiles=[configWrap.config.tmp+"app/app.all.state.js"],manifest=gulp.src(configWrap.config.revManifest);return gulp.src(revFiles).pipe(plumber({errorHandler:handleErrors})).pipe(sourcemaps.init()).pipe(revReplace({manifest:manifest})).pipe(jsTask()).pipe(rev()).pipe(sourcemaps.write(".")).pipe(mapStream(function(file,cb){file.path.endsWith(".js")&&manifestHelper.saveRev("app.all.state.js",file.path),cb(null,file)})).pipe(gulp.dest(configWrap.config.tmp+"rev/"))}function revComponent(){var revFiles=[configWrap.config.tmp+"app/**/*.component.js"],manifest=gulp.src(configWrap.config.revManifest);return gulp.src(revFiles).pipe(plumber({errorHandler:handleErrors})).pipe(sourcemaps.init()).pipe(revReplace({manifest:manifest})).pipe(jsTask()).pipe(rev()).pipe(sourcemaps.write(".")).pipe(mapStream(function(file,cb){file.path.endsWith(".js")&&manifestHelper.saveRev(file.path),cb(null,file)})).pipe(gulp.dest(configWrap.config.tmp+"rev/"))}function revReplaceIndex(){var manifest=gulp.src(configWrap.config.revManifest);return gulp.src(configWrap.config.tmp+"*.html").pipe(revReplace({manifest:manifest})).pipe(mapStream(function(file,cb){var dFile=file.path.split(path.sep).join("/").replace(configWrap.config.tmp,configWrap.config.dist);log("revReplaceIndex",dFile),fs.existsSync(dFile)&&(log("删除旧文件",dFile),fs.unlinkSync(dFile)),cb(null,file)})).pipe(gulp.dest(configWrap.config.dist))}function revReplaceHtml(){var manifest=gulp.src(configWrap.config.revManifest);return gulp.src(configWrap.config.tmp+"rev/**/*.html",{base:configWrap.config.tmp+"rev/"}).pipe(revReplace({manifest:manifest})).pipe(mapStream(function(file,cb){var dFile=file.path.split(path.sep).join("/").replace(configWrap.config.tmp+"rev/",configWrap.config.dist+"app/");log("revReplaceHtml",dFile),fs.existsSync(dFile)&&(log("删除旧文件",dFile),fs.unlinkSync(dFile)),cb(null,file)})).pipe(gulp.dest(configWrap.config.dist+"app/"))}var gulp=require("gulp"),gulpIf=require("gulp-if"),cleanCSS=require("gulp-clean-css"),sourcemaps=require("gulp-sourcemaps"),lazypipe=require("lazypipe"),mapStream=require("map-stream"),uglify=require("gulp-uglify"),plumber=require("gulp-plumber"),htmlmin=require("gulp-htmlmin"),rev=require("gulp-rev"),log=require("fancy-log"),fs=require("fs"),revReplace=require("gulp-rev-replace"),manifestHelper=require("./manifest-helper"),handleErrors=require("./handle-errors"),configWrap=require("./config-wrap"),path=require("path"),jsTask=lazypipe().pipe(uglify,{mangle:!1,compress:!0}),cssTask=lazypipe().pipe(cleanCSS);module.exports={revModules:revModules,revState:revState,revComponent:revComponent,revReplaceIndex:revReplaceIndex,revReplaceHtml:revReplaceHtml,jsTask:jsTask};