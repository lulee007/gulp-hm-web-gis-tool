"use strict";function parseVersion(){var version=null,pomXml=fs.readFileSync("pom.xml","utf8");if(parseString(pomXml,function(err,result){result.project.version&&result.project.version[0]?version=result.project.version[0]:result.project.parent&&result.project.parent[0]&&result.project.parent[0].version&&result.project.parent[0].version[0]&&(version=result.project.parent[0].version[0])}),null===version)throw new Error("pom.xml is malformed. No version is defined");return version}function parseProjectName(){var pName=null,pomXml=fs.readFileSync("pom.xml","utf8");if(parseString(pomXml,function(err,result){result.project.artifactId&&result.project.artifactId[0]&&(pName=result.project.artifactId[0])}),null===pName)throw new Error("pom.xml is malformed. No artifactId is defined");return pName}function env(){var params=_parseParams(process.argv),port=params.port;port||log("参数：port 为空（build 模式请忽略）如：--port=8080");var pages=getModuleNames();modules=pages.map(function(p){return{name:p,path:configWrap.config.webappDir+"app/"+p,tmpPath:configWrap.config.tmp+"app/"+p}});var prod=params.prod,version=parseVersion(),projectName=parseProjectName();return{params:params,modules:modules,prod:prod,port:port,projectVersion:version,projectName:projectName}}function normalFilesInModules(){var pages=getModuleNames(),files=coreConf.commonFile,commonIgnore=coreConf.commonIgnore.map(function(file){return"!"+configWrap.config.webappDir+file});for(var p in pages){var page=pages[p];files.push("app/"+page+"/**/*"),commonIgnore=commonIgnore.concat(coreConf.moduleIgnore.map(function(i){return"!"+configWrap.config.webappDir+"app/"+page+"/"+i}))}return files=files.map(function(file){return configWrap.config.webappDir+file}),files=files.concat(commonIgnore)}function moduleFiles(){var modules=env().modules,files=modules.map(function(m){return["**/*.component.js","**/*.scss","**/*.service.js","**/*.state.js","**/*.html"].map(function(type){return m.path+"/"+type})}).reduce(function(r,item){return r.concat(item)},[]);return files}function getModuleNames(){if(!_module_names){var params=_parseParams(process.argv);if(!params||!params.pages)return log("pages *********************************"),log("pages 参数错误:--pages=page1,page2,page3"),void log("pages *********************************");_module_names=params.pages.split(","),_module_names=_module_names.concat(coreConf.commonModules)}return _module_names}function _parseParams(argv){var args=argv.filter(function(arg){return arg.startsWith("--")}).map(function(arg){var argKeyValue=arg.replace("--","").split("=");return argKeyValue}).reduce(function(params,argKeyValue){return params[argKeyValue[0]]=argKeyValue[1]||"参数错误",params},{});return args}var fs=require("fs"),log=require("fancy-log"),configWrap=require("./config-wrap");module.exports={getEnv:env,parseVersion:parseVersion,parseProjectName:parseProjectName,moduleFiles:moduleFiles,normalFilesInModules:normalFilesInModules};var modules,coreConf=require("./project-common"),_module_names,parseString=require("xml2js").parseString;