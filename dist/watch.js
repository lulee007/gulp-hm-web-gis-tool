"use strict";function genNewTaskConf(type,source,targets,reload){var task={};return task.watchingList=[],task.lock=!1,task.isStart=!1,task.name=type,task.source=source,task.targets=[].concat(targets),task.reload=reload,task}function GenNewTask(conf){function addToWatching(f){for(start();currentConf.lock;)sleep(10);currentConf.lock=!0,log("watch "+currentConf.name+"：添加一个文件",f.path),currentConf.watchingList.push(f),currentConf.lock=!1}function start(){if(!currentConf.isStart){log("watch "+currentConf.name+"：开始定时处理监听列表");var loopTime=1500;"darwin"===process.platform&&(loopTime=1e3),currentConf.isStart=setInterval(function(){dealWatchingList()},loopTime)}}function stop(){currentConf.isStart&&(clearInterval(currentConf.isStart),currentConf.isStart=void 0,log("watch "+currentConf.name+"：处理列表中..."))}function dealWatchingList(){for(;currentConf.lock;)sleep(10);if(currentConf.lock=!0,currentConf.taskCount++,log("新任务",currentConf.taskCount),currentConf.watchingList.length>0){var files=currentConf.watchingList;currentConf.watchingList=[],stop();var filterdFiles=files.reduce(function(r,l){return r[l.path]=l,r},{});Object.keys(filterdFiles).forEach(function(fPath){var f=filterdFiles[fPath];currentConf.targets.forEach(function(target){var distPath=f.path.split(path.sep).join("/").replace(currentConf.source,target);log("watch "+currentConf.name+"：处理:",distPath,f.event),fs.existsSync(distPath)&&fse.removeSync(distPath),f.event.startsWith("unlink")||fs.existsSync(f.path)&&fse.copySync(f.path,distPath)})}),log("watch "+currentConf.name+"：处理列表完成"),currentConf.reload&&(currentConf.taskCount>1?(log("还未处理完成...",currentConf.taskCount),currentConf.taskCount--):(browserSync.needWait?log("有新的构建任务，取消刷新浏览器"):(browserSync.reload(),log("刷新浏览器")),currentConf.taskCount=0))}currentConf.lock=!1}function sleep(){for(var a=1,i=0;i<5e4;i++)a=i;return a}var currentConf=conf;return currentConf.taskCount=0,{addToWatching:addToWatching}}function watchAssetsVender(){var task,type="assest_vender",taskConf=watchTaskConf[type];taskConf||(watchTaskConf[type]=taskConf=genNewTaskConf(type,configWrap.config.webappDir,configWrap.config.dist),task=new GenNewTask(taskConf));var env=util.getEnv(),filesToWatch=coreConf.commonAssets.map(function(file){return configWrap.config.webappDir+file}),commonIgnore=coreConf.commonIgnore.map(function(file){return"!"+configWrap.config.webappDir+file}),moduleFiles=env.modules.map(function(m){return m.path+"/**/*.(txt|json)"}),moduleAssets=env.modules.map(function(m){return configWrap.config.webappDir+"assets/pages/"+m.name+"/**/*"});return filesToWatch=filesToWatch.concat(moduleFiles).concat(moduleAssets).concat(commonIgnore),watch(filesToWatch,WatchEvents,function(vinyl){task.addToWatching({event:vinyl.event,path:vinyl.path,base:vinyl.base})})}function watchDist(){var task,type="dist",taskConf=watchTaskConf[type];return taskConf||(watchTaskConf[type]=taskConf=genNewTaskConf(type,configWrap.config.dist,[configWrap.config.webTargetDir+util.parseProjectName()+"-"+util.parseVersion()+"/"],!0),task=new GenNewTask(taskConf)),watch(configWrap.config.dist+"**/*.*",WatchEvents,function(vinyl){task.addToWatching({event:vinyl.event,path:vinyl.path,base:vinyl.base})})}function watchModule(){function findModuleByPath(filePath){var module,env=util.getEnv(),modules=env.modules;return modules.forEach(function(m){filePath.split(path.sep).join("/").indexOf(m.path)>-1&&(module=m)}),module}var files=util.moduleFiles();return watch(files,function(vinyl){var module=findModuleByPath(vinyl.path);vinyl.path.endsWith(".component.js")?merge.mergeModuleComponent(module):vinyl.path.endsWith(".service.js")?merge.mergeModuleService(module):vinyl.path.endsWith(".scss")?merge.mergeModuleCss(module):vinyl.path.endsWith(".state.js")?merge.mergeStatesByModule():vinyl.path.endsWith(".html")||log.warn("不应该被执行",vinyl.path)})}function watchNormalJsHtml(){var env=util.getEnv(),filesToWatch=coreConf.commonFile.map(function(f){return configWrap.config.webappDir+f});filesToWatch=filesToWatch.concat(env.modules.map(function(m){return[m.path+"/**/*.js",m.path+"/**/*.html","!"+m.path+"/**/*.state.js","!"+m.path+"/**/*.component.js","!"+m.path+"/**/*.service.js"]}).reduce(function(r,item){return r.concat(item)},[]));var commonIgnore=coreConf.commonIgnore.map(function(file){return"!"+configWrap.config.webappDir+file});return filesToWatch=filesToWatch.concat(commonIgnore),watch(filesToWatch,WatchEvents,function(vinyl){var distPath=vinyl.path.split(path.sep).join("/").replace(configWrap.config.webappDir,configWrap.config.tmp);if(fse.removeSync(distPath),"unlink"!==vinyl.event)return gulp.src(vinyl.path,{base:configWrap.config.webappDir}).pipe(gulp.dest(configWrap.config.tmp))})}var gulp=require("gulp"),log=require("fancy-log"),plumber=require("gulp-plumber"),rev=require("gulp-rev"),fs=require("fs"),fse=require("fs-extra"),browserSync=require("browser-sync"),process=require("process"),watch=require("gulp-watch"),util=require("./utils"),configWrap=require("./config"),coreConf=require("./project-common"),merge=require("./merge"),minify=require("./minify"),handleErrors=require("./handle-errors"),manifestHelper=require("./manifest-helper"),path=require("path"),watchTaskConf={assets_vender:void 0,dist:void 0},WatchEvents={events:["add","change","unlink"]};module.exports={assets_vender:watchAssetsVender,dist:watchDist,module:watchModule,normalJsHtml:watchNormalJsHtml};