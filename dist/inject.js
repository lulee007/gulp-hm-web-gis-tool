"use strict";function index(){var env=util.getEnv(),pages=env.modules.map(function(m){return m.name}),coreConf=require("./project-common"),pomVer=util.parseVersion(),deffered=Q.defer(),packageTime="当前版本号："+pomVer+" 打包时间："+(new Date).toLocaleDateString()+" "+(new Date).toLocaleTimeString(),packedPages=pages.filter(function(p){return coreConf.commonModules.indexOf(p)===-1}),modulesCount=packedPages.length+1;return packedPages.forEach(function(page){gulp.src(configWrap.config.webappDir+"/template/index.html").pipe(plumber({errorHandler:handleErrors})).pipe(mapStream(function(file,cb){var html=file.contents.toString(),allJs=[].concat(coreConf.coreJs),allCss=[].concat(coreConf.coreCss),pageConf=require(configWrap.config.gulpDir+"project-"+page);allJs=allJs.concat(pageConf.venderJs),allCss=allCss.concat(pageConf.venderCss);var jsList=allJs.map(function(js){return'<script src="'+js+'" type="text/javascript"></script>'}).join("\r\n"),cssList=allCss.map(function(css){return'<link rel="stylesheet" href="'+css+'">'}).join("\r\n");html=html.replace("<!-- inject:css:here -->",cssList),html=html.replace("<!-- inject:js:here -->",jsList),file.contents=new Buffer(html,"utf-8");var dFile=file.path.split(path.sep).join("/").replace(configWrap.config.webappDir+"template/",configWrap.config.tmp).replace("index.html",page+".html");log("packedPages",packageTime,dFile),fs.existsSync(dFile)&&(log("删除旧文件",dFile),fs.unlinkSync(dFile)),cb(null,file)})).pipe(injectString.replace("--package-time-inject-here--",packageTime)).pipe(prettify({indent_char:" ",indent_size:2})).pipe(rename(page+".html")).pipe(gulp.dest(configWrap.config.tmp)).on("end",function(){modulesCount--,modulesCount<=0&&deffered.resolve()})}),gulp.src(configWrap.config.webappDir+"/template/index.html").pipe(plumber({errorHandler:handleErrors})).pipe(mapStream(function(file,cb){var html=file.contents.toString(),allJs=[].concat(coreConf.coreJs),allCss=[].concat(coreConf.coreCss);pages.forEach(function(page){coreConf.commonModules.indexOf(page)>-1&&log("index index 系统模块",page);var pageConf=require((coreConf.commonModules.indexOf(page)>-1?"./":configWrap.config.gulpDir)+"project-"+page);allJs=allJs.concat(pageConf.venderJs)}),allJs=allJs.reduce(function(r,js){return r.indexOf(js)>-1?log("存在重复js，去重",js):r.push(js),r},[]),allCss=allCss.reduce(function(r,css){return r.indexOf(css)>-1?log("存在重复css，去重",css):r.push(css),r},[]);var jsList=allJs.map(function(js){return'<script src="'+js+'" type="text/javascript"></script>'}).join("\r\n"),cssList=allCss.map(function(css){return'<link rel="stylesheet" href="'+css+'">'}).join("\r\n");html=html.replace("<!-- inject:css:here -->",cssList),html=html.replace("<!-- inject:js:here -->",jsList),file.contents=new Buffer(html,"utf-8");var dFile=file.path.split(path.sep).join("/").replace(configWrap.config.webappDir+"template/",configWrap.config.tmp);log(packageTime,dFile),fs.existsSync(dFile)&&(log("删除旧文件",dFile),fs.unlinkSync(dFile)),cb(null,file)})).pipe(injectString.replace("--package-time-inject-here--",packageTime)).pipe(prettify({indent_char:" ",indent_size:2})).pipe(gulp.dest(configWrap.config.tmp)).on("end",function(){modulesCount--,modulesCount<=0&&deffered.resolve()}),deffered.promise}function homeModule(){var env=util.getEnv(),modules=env.modules,modulesString=modules.map(function(m){return m.name}).join("','");return gulp.src(configWrap.config.webappDir+"app/home/home.controller.js",{base:configWrap.config.webappDir}).pipe(mapStream(function(file,cb){var state=file.contents.toString();state=state.replace("--inject modules here--",modulesString),log("modulesString",modulesString),file.contents=new Buffer(state,"utf-8");var oldFile=file.path.split(path.sep).join("/").replace(configWrap.config.webappDir,configWrap.config.tmp);fs.existsSync(oldFile)&&(log("删除旧文件",oldFile),fs.unlinkSync(oldFile)),cb(null,file)})).pipe(gulp.dest(configWrap.config.tmp))}function states(){var env=util.getEnv(),modules=env.modules,deferred=Q.defer(),asyncCount=modules.length,coreConf=require("./project-common");return modules.forEach(function(m){var allCss=[],dir=m.tmpPath;coreConf.commonModules.indexOf(m.name)>-1&&log("states 系统模块",m.name);var mConf=require((coreConf.commonModules.indexOf(m.name)>-1?"./":configWrap.config.gulpDir)+"project-"+m.name);allCss=allCss.concat(mConf.venderCss),gulp.src([dir+"/*.state.js"],{base:"./"}).pipe(mapStream(function(file,cb){var state=file.contents.toString();state=state.replace("// <insert all css here>",allCss.map(function(css){return"'"+css+"',"}).join("\r\n")),file.contents=new Buffer(state,"utf-8"),log("删除旧文件",file.path),fs.unlinkSync(file.path),cb(null,file)})).pipe(gulp.dest("./")).on("end",function(){asyncCount--,asyncCount<=0?deferred.resolve():console.log("inject state: "+dir+"/"+m.name+".state.js")})}),deferred.promise}function constants(){var appConstants=configWrap.config.APPCONSTANTS,env=util.getEnv(),pages=env.pages,pagesString=pages.join("','");return gulp.src(configWrap.config.webappDir+"app/app.constants.js",{base:configWrap.config.webappDir}).pipe(mapStream(function(file,cb){var constantContent=file.contents.toString(),unWrapConstantContent=JSON.stringify(appConstants).replace("{","");unWrapConstantContent=unWrapConstantContent.substring(0,unWrapConstantContent.lastIndexOf("}")),constantContent=constantContent.replace("--inject pages here--",pagesString).replace("//--inject APPCONSTANTS here--",unWrapConstantContent).replace("'--inject APIHOST here--'",appConstants.API_HOST.split("/").filter(function(p){return p}).join("\\/")),log("pagesString",pagesString),file.contents=new Buffer(constantContent,"utf-8");var oldFile=file.path.split(path.sep).join("/").replace(configWrap.config.webappDir,configWrap.config.tmp);fs.existsSync(oldFile)&&(log("删除旧文件",oldFile),fs.unlinkSync(oldFile)),cb(null,file)})).pipe(jsprettify()).pipe(gulp.dest(configWrap.config.tmp))}var gulp=require("gulp"),plumber=require("gulp-plumber"),Q=require("q"),fs=require("fs"),jsprettify=require("gulp-jsbeautifier"),injectString=require("gulp-inject-string"),rename=require("gulp-rename"),mapStream=require("map-stream"),prettify=require("gulp-html-prettify"),log=require("fancy-log"),path=require("path"),handleErrors=require("./handle-errors"),util=require("./utils"),configWrap=require("./config-wrap");module.exports={states:states,index:index,homeModule:homeModule,constants:constants};